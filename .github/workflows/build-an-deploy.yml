name: Build and SonarQube Analysis

on:
  push:
    branches: [ main ]

jobs:
  sonar:
    runs-on: self-hosted

    steps:
      # 1️⃣ Checkout du code
      - uses: actions/checkout@v4
        with:
          submodules: false   # Désactive les sous-modules pour éviter les erreurs

      # 2️⃣ Setup JDK 21
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: zulu

      # 3️⃣ Build & SonarQube Analysis
      - name: Build & SonarQube Analysis
        shell: powershell
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: http://localhost:9000
        run: |
          # Débogage : afficher l'URL utilisée
          $sonarUrl = $env:SONAR_HOST_URL
          $sonarToken = $env:SONAR_TOKEN
          Write-Host "Using SonarQube URL: $sonarUrl"

          # Lancer Maven avec les options correctement évaluées
          mvn clean verify sonar:sonar `
            -D"sonar.projectKey=TP_SonarQube" `
            -D"sonar.host.url=$sonarUrl" `
            -D"sonar.login=$sonarToken"
